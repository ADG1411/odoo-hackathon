{% extends "base.html" %}

{% block title %}Maintenance Calendar - GearGuard{% endblock %}

{% block extra_css %}
<style>
  .calendar-wrapper {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-card);
    overflow: hidden;
    width: 100%;
  }
  
  .calendar-toolbar {
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: var(--space-md);
    background: var(--bg-card);
  }
  
  .calendar-nav-group {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }
  
  .calendar-title {
    font-size: 1.125rem;
    font-weight: 600;
    min-width: 180px;
    text-align: center;
    margin: 0 var(--space-sm);
  }
  
  .calendar-view-switcher {
    display: flex;
    background: var(--bg-hover);
    border-radius: var(--radius-md);
    padding: 4px;
  }
  
  .view-btn {
    padding: 8px 16px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
  }
  
  .view-btn:hover {
    color: var(--text-primary);
  }
  
  .view-btn.active {
    background: var(--bg-card);
    color: var(--text-primary);
    box-shadow: var(--shadow-sm);
  }
  
  .calendar-grid-container {
    padding: var(--space-lg);
  }
  
  /* Month View */
  .month-view {
    display: none;
  }
  
  .month-view.active {
    display: block;
  }
  
  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--border-light);
    border-radius: var(--radius-md) var(--radius-md) 0 0;
    overflow: hidden;
  }
  
  .weekday {
    padding: var(--space-md);
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    background: var(--bg-hover);
  }
  
  .calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--border-light);
    border-radius: 0 0 var(--radius-md) var(--radius-md);
    overflow: hidden;
  }
  
  .calendar-day {
    background: var(--bg-card);
    min-height: 120px;
    padding: var(--space-sm);
    cursor: pointer;
    transition: background var(--transition-fast);
    display: flex;
    flex-direction: column;
  }
  
  .calendar-day:hover {
    background: var(--bg-hover);
  }
  
  .calendar-day.other-month {
    background: #f8fafc;
    opacity: 0.5;
  }
  
  .calendar-day.other-month .day-number {
    color: var(--text-muted);
  }
  
  .calendar-day.today {
    background: var(--primary-light);
  }
  
  .calendar-day.selected {
    background: var(--primary-light);
    box-shadow: inset 0 0 0 2px var(--primary);
  }
  
  .day-header {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    margin-bottom: var(--space-xs);
    min-height: 32px;
  }
  
  .day-number {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-full);
  }
  
  .calendar-day.today .day-number {
    background: var(--primary);
    color: white;
    font-weight: 600;
  }
  
  .day-events {
    display: flex;
    flex-direction: column;
    gap: 3px;
    flex: 1;
    overflow: hidden;
  }
  
  .calendar-event {
    padding: 3px 6px;
    font-size: 0.6875rem;
    font-weight: 500;
    border-radius: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
    transition: all var(--transition-fast);
    border-left: 3px solid transparent;
    line-height: 1.3;
  }
  
  .calendar-event:hover {
    transform: translateX(2px);
  }
  
  .calendar-event[draggable="true"] {
    cursor: grab;
  }
  
  .calendar-event[draggable="true"]:active {
    cursor: grabbing;
  }
  
  .calendar-event.dragging {
    opacity: 0.5;
  }
  
  /* Calendar drag & drop states */
  .calendar-day.drag-over {
    background: var(--primary-light) !important;
    box-shadow: inset 0 0 0 2px var(--primary);
  }
  
  .calendar-drag-toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--text-primary);
    color: white;
    padding: 12px 24px;
    border-radius: var(--radius-md);
    font-size: 14px;
    font-weight: 500;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
  }
  
  .calendar-drag-toast.visible {
    opacity: 1;
  }
  
  .calendar-event.priority-low {
    background: #f1f5f9;
    color: var(--text-secondary);
    border-left-color: var(--priority-low);
  }
  
  .calendar-event.priority-normal {
    background: var(--info-light);
    color: #1d4ed8;
    border-left-color: var(--priority-normal);
  }
  
  .calendar-event.priority-high {
    background: var(--warning-light);
    color: #b45309;
    border-left-color: var(--priority-high);
  }
  
  .calendar-event.priority-urgent {
    background: var(--danger-light);
    color: var(--danger);
    border-left-color: var(--priority-urgent);
  }
  
  .more-events {
    font-size: 0.6875rem;
    color: var(--text-muted);
    padding: 2px 8px;
    cursor: pointer;
  }
  
  .more-events:hover {
    color: var(--primary);
  }
  
  /* Sidebar legend & upcoming */
  .calendar-sidebar {
    width: 280px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) 0;
  }
  
  .legend-color {
    width: 12px;
    height: 12px;
    border-radius: var(--radius-sm);
  }
  
  .legend-label {
    font-size: 0.8125rem;
    color: var(--text-secondary);
  }
  
  /* Week View */
  .week-view {
    display: none;
  }
  
  .week-view.active {
    display: block;
  }
  
  .week-grid {
    display: grid;
    grid-template-columns: 70px repeat(7, 1fr);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--bg-card);
  }
  
  .week-header {
    display: contents;
  }
  
  .week-header-cell {
    padding: var(--space-md);
    text-align: center;
    background: var(--bg-hover);
    border-bottom: 2px solid var(--border-light);
    border-right: 1px solid var(--border-light);
    font-weight: 500;
    font-size: 0.8125rem;
  }
  
  .week-header-cell:first-child {
    border-right: 1px solid var(--border-light);
  }
  
  .week-header-cell:last-child {
    border-right: none;
  }
  
  .week-header-cell.today {
    background: var(--primary-light);
  }
  
  .week-header-cell.today .week-day-number {
    background: var(--primary);
    color: white;
    border-radius: var(--radius-full);
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .time-slot {
    padding: var(--space-sm);
    font-size: 0.75rem;
    color: var(--text-muted);
    text-align: right;
    padding-right: var(--space-md);
    border-right: 1px solid var(--border-light);
    border-bottom: 1px solid var(--border-light);
    background: var(--bg-hover);
  }
  
  .week-cell {
    min-height: 60px;
    border-right: 1px solid var(--border-light);
    border-bottom: 1px solid var(--border-light);
    padding: 4px;
    position: relative;
    background: var(--bg-card);
  }
  
  .week-cell:nth-child(8n+1) {
    border-right: 1px solid var(--border-light);
  }
  
  .week-grid > .week-cell:nth-child(8n) {
    border-right: none;
  }
  
  /* Day View */
  .day-view {
    display: none;
  }
  
  .day-view.active {
    display: block;
  }
  
  .day-schedule {
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    overflow: hidden;
  }
  
  .day-header-bar {
    padding: var(--space-lg);
    background: var(--bg-hover);
    border-bottom: 1px solid var(--border-light);
    text-align: center;
  }
  
  .day-header-bar h3 {
    font-size: 1.125rem;
    margin-bottom: 4px;
  }
  
  .day-header-bar span {
    font-size: 0.875rem;
    color: var(--text-muted);
  }
  
  .day-hours {
    max-height: 600px;
    overflow-y: auto;
  }
  
  .hour-row {
    display: flex;
    border-bottom: 1px solid var(--border-light);
    min-height: 80px;
  }
  
  .hour-row:last-child {
    border-bottom: none;
  }
  
  .hour-label {
    width: 60px;
    padding: var(--space-sm);
    font-size: 0.75rem;
    color: var(--text-muted);
    text-align: right;
    border-right: 1px solid var(--border-light);
    flex-shrink: 0;
  }
  
  .hour-content {
    flex: 1;
    padding: var(--space-sm);
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }
  
  .hour-event {
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-sm);
    font-size: 0.8125rem;
    cursor: pointer;
    transition: all var(--transition-fast);
  }
  
  .hour-event:hover {
    transform: scale(1.02);
  }
  
  .hour-event-title {
    font-weight: 500;
    margin-bottom: 2px;
  }
  
  .hour-event-meta {
    font-size: 0.75rem;
    opacity: 0.8;
  }
  
  /* Responsive */
  @media (max-width: 1024px) {
    .calendar-sidebar {
      display: none;
    }
    
    .calendar-day {
      min-height: 90px;
    }
  }
  
  @media (max-width: 768px) {
    .calendar-day {
      min-height: 60px;
      padding: 4px;
    }
    
    .day-number {
      font-size: 0.75rem;
      width: 24px;
      height: 24px;
    }
    
    .day-header {
      min-height: 26px;
    }
    
    .calendar-event {
      font-size: 0.625rem;
      padding: 2px 4px;
    }
    
    .calendar-view-switcher {
      display: none;
    }
    
    .calendar-title {
      font-size: 1rem;
    }
  }
</style>
{% endblock %}

{% block body %}
<div class="app-layout">
  <!-- Sidebar -->
  {% include "partials/sidebar.html" %}
  
  <!-- Main Content -->
  <main class="main-content">
    <!-- Page Header -->
    <header class="page-header">
      <div class="page-header-content">
        <div class="page-title-section">
          <nav class="page-breadcrumb">
            <a href="/">Home</a>
            <i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i>
            <span>Calendar</span>
          </nav>
          <h1 class="page-title">Maintenance Calendar</h1>
        </div>
        
        <div class="page-actions">
          <button class="btn btn-secondary btn-sm" onclick="goToToday()">
            <i data-lucide="calendar" style="width: 16px; height: 16px;"></i>
            <span>Today</span>
          </button>
          <button class="btn btn-primary btn-sm" onclick="openCreateEvent()">
            <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
            <span>Schedule</span>
          </button>
        </div>
      </div>
    </header>
    
    <!-- Page Body -->
    <div class="page-body">
      <div class="page-body-inner">
        <div style="display: flex; gap: var(--space-xl); align-items: flex-start;">
          
          <!-- Main Calendar -->
          <div style="flex: 1; min-width: 0;">
            <div class="calendar-wrapper">
              <!-- Toolbar -->
              <div class="calendar-toolbar">
                <div class="calendar-nav-group">
                  <button class="btn btn-icon btn-secondary" onclick="prevPeriod()">
                    <i data-lucide="chevron-left" style="width: 18px; height: 18px;"></i>
                  </button>
                  <button class="btn btn-icon btn-secondary" onclick="nextPeriod()">
                    <i data-lucide="chevron-right" style="width: 18px; height: 18px;"></i>
                  </button>
                  <h2 class="calendar-title" id="calendar-title">December 2025</h2>
                </div>
                
                <div class="calendar-view-switcher">
                  <button class="view-btn" data-view="day" onclick="switchView('day')">Day</button>
                  <button class="view-btn" data-view="week" onclick="switchView('week')">Week</button>
                  <button class="view-btn active" data-view="month" onclick="switchView('month')">Month</button>
                </div>
              </div>
              
              <!-- Month View -->
              <div class="calendar-grid-container month-view active" id="month-view">
                <div class="calendar-weekdays">
                  <div class="weekday">Sun</div>
                  <div class="weekday">Mon</div>
                  <div class="weekday">Tue</div>
                  <div class="weekday">Wed</div>
                  <div class="weekday">Thu</div>
                  <div class="weekday">Fri</div>
                  <div class="weekday">Sat</div>
                </div>
                <div class="calendar-days" id="calendar-days">
                  <!-- Days generated by JavaScript -->
                </div>
              </div>
              
              <!-- Week View -->
              <div class="calendar-grid-container week-view" id="week-view">
                <div class="week-grid" id="week-grid">
                  <!-- Generated by JavaScript -->
                </div>
              </div>
              
              <!-- Day View -->
              <div class="calendar-grid-container day-view" id="day-view">
                <div class="day-schedule" id="day-schedule">
                  <!-- Generated by JavaScript -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Sidebar -->
          <div class="calendar-sidebar">
            <!-- Legend -->
            <div class="widget">
              <div class="widget-header">
                <h3 class="widget-title">Priority Legend</h3>
              </div>
              <div class="widget-body">
                <div class="legend-item">
                  <div class="legend-color" style="background: var(--priority-urgent);"></div>
                  <span class="legend-label">Urgent</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color" style="background: var(--priority-high);"></div>
                  <span class="legend-label">High Priority</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color" style="background: var(--priority-normal);"></div>
                  <span class="legend-label">Normal</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color" style="background: var(--priority-low);"></div>
                  <span class="legend-label">Low Priority</span>
                </div>
              </div>
            </div>
            
            <!-- Upcoming Maintenance -->
            <div class="widget">
              <div class="widget-header">
                <h3 class="widget-title">Upcoming</h3>
                <a href="/requests" class="btn btn-ghost btn-sm">View All</a>
              </div>
              <div class="widget-body">
                <ul class="widget-list" id="upcoming-list">
                  <li class="widget-list-item" style="cursor: pointer;" onclick="viewEvent(1)">
                    <div style="width: 4px; height: 40px; background: var(--priority-urgent); border-radius: 2px; margin-right: var(--space-sm);"></div>
                    <div style="flex: 1;">
                      <div style="font-weight: 500; font-size: 0.875rem;">Hydraulic Press #7</div>
                      <div style="font-size: 0.75rem; color: var(--text-muted);">Today, 2:00 PM • 4 hrs</div>
                    </div>
                  </li>
                  <li class="widget-list-item" style="cursor: pointer;" onclick="viewEvent(2)">
                    <div style="width: 4px; height: 40px; background: var(--priority-normal); border-radius: 2px; margin-right: var(--space-sm);"></div>
                    <div style="flex: 1;">
                      <div style="font-weight: 500; font-size: 0.875rem;">Generator Unit 1</div>
                      <div style="font-size: 0.75rem; color: var(--text-muted);">Dec 28, 9:00 AM • 4 hrs</div>
                    </div>
                  </li>
                  <li class="widget-list-item" style="cursor: pointer;" onclick="viewEvent(3)">
                    <div style="width: 4px; height: 40px; background: var(--priority-normal); border-radius: 2px; margin-right: var(--space-sm);"></div>
                    <div style="flex: 1;">
                      <div style="font-weight: 500; font-size: 0.875rem;">Robotic Arm Unit 5</div>
                      <div style="font-size: 0.75rem; color: var(--text-muted);">Dec 30, 8:00 AM • 6 hrs</div>
                    </div>
                  </li>
                  <li class="widget-list-item" style="cursor: pointer;" onclick="viewEvent(4)">
                    <div style="width: 4px; height: 40px; background: var(--priority-low); border-radius: 2px; margin-right: var(--space-sm);"></div>
                    <div style="flex: 1;">
                      <div style="font-weight: 500; font-size: 0.875rem;">HVAC System B2</div>
                      <div style="font-size: 0.75rem; color: var(--text-muted);">Jan 2, 10:00 AM • 3 hrs</div>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Event Detail Side Panel -->
<div class="side-panel-overlay" id="event-panel-overlay" onclick="closeEventPanel()"></div>
<div class="side-panel" id="event-panel">
  <div class="modal-header">
    <h2 class="modal-title">Maintenance Details</h2>
    <button class="modal-close" onclick="closeEventPanel()">
      <i data-lucide="x" style="width: 20px; height: 20px;"></i>
    </button>
  </div>
  <div class="modal-body" id="event-panel-content">
    <!-- Content loaded dynamically -->
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeEventPanel()">Close</button>
    <button class="btn btn-primary" onclick="editEvent()">
      <i data-lucide="pencil" style="width: 16px; height: 16px;"></i>
      Edit
    </button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Calendar State
let currentDate = new Date();
let currentView = 'month';
let selectedDate = null;

// Events loaded from API
let events = [];

// Load events from API
async function loadEvents() {
  try {
    const data = await GearGuardAPI.requests.getAll();
    const requests = data.requests || data || [];
    
    // Convert maintenance requests to calendar events
    events = requests.map(req => ({
      id: req.id,
      title: req.equipment?.name || req.name || 'Maintenance Request',
      date: req.scheduled_date ? req.scheduled_date.split('T')[0] : formatDateStr(new Date()),
      time: req.scheduled_date ? req.scheduled_date.split('T')[1]?.substring(0, 5) || '09:00' : '09:00',
      duration: req.duration || 2,
      priority: req.priority === 'high' ? 'urgent' : (req.priority || 'normal'),
      type: req.maintenance_type || 'corrective',
      team: req.team?.name || 'Unassigned',
      technician: req.requester_name || 'Unassigned',
      requestName: req.name,
      stage: req.stage?.name
    }));
    
    updateView();
  } catch (error) {
    console.error('Failed to load events:', error);
    events = [];
    updateView();
  }
}

// Initialize calendar
function initCalendar() {
  loadEvents();
  updateTitle();
}

// Render month view
function renderCalendar() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  // First day of the month
  const firstDay = new Date(year, month, 1);
  // Start from the Sunday of the week containing the first day
  const startDate = new Date(firstDay);
  startDate.setDate(1 - firstDay.getDay());
  
  const daysContainer = document.getElementById('calendar-days');
  daysContainer.innerHTML = '';
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Generate 42 days (6 weeks)
  for (let i = 0; i < 42; i++) {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + i);
    date.setHours(0, 0, 0, 0);
    
    const isOtherMonth = date.getMonth() !== month;
    const isToday = date.getTime() === today.getTime();
    const dateStr = formatDateStr(date);
    
    const dayEvents = events.filter(e => e.date === dateStr);
    
    const dayEl = document.createElement('div');
    dayEl.className = 'calendar-day';
    if (isOtherMonth) dayEl.classList.add('other-month');
    if (isToday) dayEl.classList.add('today');
    dayEl.dataset.date = dateStr;
    dayEl.onclick = () => selectDate(date);
    
    // Add drop zone handlers for drag & drop
    dayEl.ondragover = handleCalendarDragOver;
    dayEl.ondragleave = handleCalendarDragLeave;
    dayEl.ondrop = (e) => handleCalendarDrop(e, dateStr);
    
    dayEl.innerHTML = `
      <div class="day-header">
        <span class="day-number">${date.getDate()}</span>
      </div>
      <div class="day-events">
        ${dayEvents.slice(0, 3).map(e => `
          <div class="calendar-event priority-${e.priority}" 
               draggable="true"
               data-event-id="${e.id}"
               ondragstart="handleEventDragStart(event, ${e.id})"
               ondragend="handleEventDragEnd(event)"
               onclick="event.stopPropagation(); viewEvent(${e.id})">
            ${e.title}
          </div>
        `).join('')}
        ${dayEvents.length > 3 ? `<div class="more-events">+${dayEvents.length - 3} more</div>` : ''}
      </div>
    `;
    
    daysContainer.appendChild(dayEl);
  }
}

// Render week view
function renderWeekView() {
  const startOfWeek = new Date(currentDate);
  startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
  startOfWeek.setHours(0, 0, 0, 0);
  
  const weekGrid = document.getElementById('week-grid');
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  
  // Build header row
  let html = '<div class="week-header-cell" style="border-bottom: 2px solid var(--border-light);"></div>';
  
  for (let i = 0; i < 7; i++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + i);
    date.setHours(0, 0, 0, 0);
    const isToday = date.getTime() === today.getTime();
    const dayName = dayNames[date.getDay()];
    
    html += `
      <div class="week-header-cell ${isToday ? 'today' : ''}">
        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">${dayName}</div>
        <div class="week-day-number" style="font-size: 1.25rem; font-weight: 600; margin-top: 2px;">${date.getDate()}</div>
      </div>
    `;
  }
  
  // Time slots (7 AM - 7 PM)
  for (let hour = 7; hour <= 19; hour++) {
    const hourDisplay = hour === 0 ? 12 : (hour > 12 ? hour - 12 : hour);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    html += `<div class="time-slot">${hourDisplay} ${ampm}</div>`;
    
    for (let day = 0; day < 7; day++) {
      const date = new Date(startOfWeek);
      date.setDate(startOfWeek.getDate() + day);
      const dateStr = formatDateStr(date);
      const hourEvents = events.filter(e => e.date === dateStr && parseInt(e.time.split(':')[0]) === hour);
      
      html += `
        <div class="week-cell">
          ${hourEvents.map(e => `
            <div class="calendar-event priority-${e.priority}" style="font-size: 0.6875rem; padding: 4px 6px;" onclick="viewEvent(${e.id})">
              ${e.title}
            </div>
          `).join('')}
        </div>
      `;
    }
  }
  
  weekGrid.innerHTML = html;
}

// Render day view
function renderDayView() {
  const daySchedule = document.getElementById('day-schedule');
  const dateStr = formatDateStr(currentDate);
  const dayEvents = events.filter(e => e.date === dateStr);
  
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  
  let html = `
    <div class="day-header-bar">
      <h3>${dayNames[currentDate.getDay()]}</h3>
      <span>${monthNames[currentDate.getMonth()]} ${currentDate.getDate()}, ${currentDate.getFullYear()}</span>
    </div>
    <div class="day-hours">
  `;
  
  for (let hour = 6; hour <= 20; hour++) {
    const hourEvents = dayEvents.filter(e => parseInt(e.time.split(':')[0]) === hour);
    
    html += `
      <div class="hour-row">
        <div class="hour-label">${hour > 12 ? hour - 12 : hour}:00 ${hour >= 12 ? 'PM' : 'AM'}</div>
        <div class="hour-content">
          ${hourEvents.map(e => `
            <div class="hour-event priority-${e.priority}" style="background: var(--${e.priority === 'urgent' ? 'danger' : e.priority === 'high' ? 'warning' : e.priority === 'normal' ? 'info' : 'bg-hover'}-light);" onclick="viewEvent(${e.id})">
              <div class="hour-event-title">${e.title}</div>
              <div class="hour-event-meta">${e.time} • ${e.duration} hours • ${e.technician}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  html += '</div>';
  daySchedule.innerHTML = html;
}

// Helper functions
function formatDateStr(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
}

function updateTitle() {
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  
  if (currentView === 'month') {
    document.getElementById('calendar-title').textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
  } else if (currentView === 'week') {
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    document.getElementById('calendar-title').textContent = `${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getDate()} - ${endOfWeek.getDate()}, ${startOfWeek.getFullYear()}`;
  } else {
    document.getElementById('calendar-title').textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getDate()}, ${currentDate.getFullYear()}`;
  }
}

// Navigation
function prevPeriod() {
  if (currentView === 'month') {
    currentDate.setMonth(currentDate.getMonth() - 1);
  } else if (currentView === 'week') {
    currentDate.setDate(currentDate.getDate() - 7);
  } else {
    currentDate.setDate(currentDate.getDate() - 1);
  }
  updateView();
}

function nextPeriod() {
  if (currentView === 'month') {
    currentDate.setMonth(currentDate.getMonth() + 1);
  } else if (currentView === 'week') {
    currentDate.setDate(currentDate.getDate() + 7);
  } else {
    currentDate.setDate(currentDate.getDate() + 1);
  }
  updateView();
}

function goToToday() {
  currentDate = new Date();
  updateView();
}

function switchView(view) {
  currentView = view;
  
  // Update buttons
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.view === view);
  });
  
  // Show/hide views
  document.getElementById('month-view').classList.toggle('active', view === 'month');
  document.getElementById('week-view').classList.toggle('active', view === 'week');
  document.getElementById('day-view').classList.toggle('active', view === 'day');
  
  updateView();
}

function updateView() {
  updateTitle();
  if (currentView === 'month') {
    renderCalendar();
  } else if (currentView === 'week') {
    renderWeekView();
  } else {
    renderDayView();
  }
}

function selectDate(date) {
  currentDate = date;
  switchView('day');
}

// Event panel
function viewEvent(id) {
  const event = events.find(e => e.id === id);
  if (!event) return;
  
  const priorityColors = {
    urgent: 'var(--danger)',
    high: 'var(--warning)',
    normal: 'var(--info)',
    low: 'var(--priority-low)'
  };
  
  const content = document.getElementById('event-panel-content');
  content.innerHTML = `
    <div style="margin-bottom: var(--space-xl);">
      <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-lg);">
        <div class="avatar avatar-lg" style="background: ${priorityColors[event.priority]}20; color: ${priorityColors[event.priority]};">
          <i data-lucide="wrench" style="width: 28px; height: 28px;"></i>
        </div>
        <div>
          <h3 style="margin-bottom: 4px;">${event.title}</h3>
          <span class="badge badge-priority-${event.priority}" style="text-transform: capitalize;">${event.priority}</span>
        </div>
      </div>
    </div>
    
    <div style="margin-bottom: var(--space-xl);">
      <h4 style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: var(--space-md);">SCHEDULE</h4>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md);">
        <div class="card-static" style="padding: var(--space-md);">
          <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Date</div>
          <div style="font-weight: 500;">${new Date(event.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
        </div>
        <div class="card-static" style="padding: var(--space-md);">
          <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Time</div>
          <div style="font-weight: 500;">${event.time}</div>
        </div>
        <div class="card-static" style="padding: var(--space-md);">
          <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Duration</div>
          <div style="font-weight: 500;">${event.duration} hours</div>
        </div>
        <div class="card-static" style="padding: var(--space-md);">
          <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Type</div>
          <div style="font-weight: 500; text-transform: capitalize;">${event.type}</div>
        </div>
      </div>
    </div>
    
    <div style="margin-bottom: var(--space-xl);">
      <h4 style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: var(--space-md);">ASSIGNMENT</h4>
      <div class="card-static" style="padding: var(--space-md);">
        <div style="display: flex; align-items: center; gap: var(--space-md);">
          <div class="avatar">${event.technician.split(' ').map(n => n[0]).join('')}</div>
          <div>
            <div style="font-weight: 500;">${event.technician}</div>
            <div style="font-size: 0.8125rem; color: var(--text-muted);">${event.team}</div>
          </div>
        </div>
      </div>
    </div>
    
    <div>
      <h4 style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: var(--space-md);">QUICK ACTIONS</h4>
      <div style="display: flex; gap: var(--space-sm);">
        <button class="btn btn-secondary btn-sm" onclick="rescheduleEvent(${event.id})">
          <i data-lucide="calendar" style="width: 14px; height: 14px;"></i>
          Reschedule
        </button>
        <button class="btn btn-secondary btn-sm" onclick="reassignEvent(${event.id})">
          <i data-lucide="user-plus" style="width: 14px; height: 14px;"></i>
          Reassign
        </button>
      </div>
    </div>
  `;
  
  lucide.createIcons();
  document.getElementById('event-panel-overlay').classList.add('active');
  document.getElementById('event-panel').classList.add('active');
}

function closeEventPanel() {
  document.getElementById('event-panel-overlay').classList.remove('active');
  document.getElementById('event-panel').classList.remove('active');
}

function editEvent() {
  closeEventPanel();
  window.location.href = '/requests?action=edit';
}

function openCreateEvent() {
  window.location.href = '/requests?action=create';
}

function rescheduleEvent(id) {
  showToast('Reschedule', 'Drag and drop the event to a new date', 'info');
  closeEventPanel();
}

function reassignEvent(id) {
  showToast('Reassign', 'Opening technician selector...', 'info');
}

// ==========================================
// Drag & Drop for Calendar Events
// ==========================================
let draggedEventId = null;
let draggedEventElement = null;

function handleEventDragStart(event, eventId) {
  draggedEventId = eventId;
  draggedEventElement = event.target;
  event.target.classList.add('dragging');
  event.dataTransfer.effectAllowed = 'move';
  event.dataTransfer.setData('text/plain', eventId);
  
  // Show drag toast
  showDragToast('Drag to a new date to reschedule');
}

function handleEventDragEnd(event) {
  event.target.classList.remove('dragging');
  draggedEventId = null;
  draggedEventElement = null;
  
  // Remove all drag-over states
  document.querySelectorAll('.calendar-day.drag-over').forEach(day => {
    day.classList.remove('drag-over');
  });
  
  // Hide drag toast
  hideDragToast();
}

function handleCalendarDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  event.currentTarget.classList.add('drag-over');
}

function handleCalendarDragLeave(event) {
  event.currentTarget.classList.remove('drag-over');
}

async function handleCalendarDrop(event, dateStr) {
  event.preventDefault();
  event.currentTarget.classList.remove('drag-over');
  
  const eventId = parseInt(event.dataTransfer.getData('text/plain'));
  if (!eventId || !dateStr) return;
  
  try {
    const response = await fetch(`/api/requests/${eventId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        scheduled_date: dateStr
      })
    });
    
    if (response.ok) {
      showToast('Success', 'Event rescheduled successfully', 'success');
      // Refresh calendar to show updated event
      loadEvents();
    } else {
      const error = await response.json();
      showToast('Error', error.error || 'Failed to reschedule event', 'error');
    }
  } catch (error) {
    console.error('Error rescheduling event:', error);
    showToast('Error', 'Failed to reschedule event', 'error');
  }
}

function showDragToast(message) {
  let toast = document.getElementById('drag-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'drag-toast';
    toast.className = 'calendar-drag-toast';
    document.body.appendChild(toast);
  }
  toast.textContent = message;
  toast.classList.add('active');
}

function hideDragToast() {
  const toast = document.getElementById('drag-toast');
  if (toast) {
    toast.classList.remove('active');
  }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', initCalendar);

// Keyboard navigation
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeEventPanel();
  }
  if (e.key === 'ArrowLeft') {
    prevPeriod();
  }
  if (e.key === 'ArrowRight') {
    nextPeriod();
  }
});
</script>
{% endblock %}
