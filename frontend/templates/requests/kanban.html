{% extends "base.html" %}
{% block title %}Kanban Board - GearGuard{% endblock %}

{% block extra_css %}
<style>
.kanban-board {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding-bottom: 1rem;
    min-height: calc(100vh - 200px);
}

.kanban-column {
    min-width: 320px;
    max-width: 320px;
    background: var(--bg-secondary);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
}

.kanban-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.kanban-header h6 {
    margin: 0;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.kanban-header .badge {
    font-size: 0.75rem;
}

.kanban-body {
    padding: 0.75rem;
    flex: 1;
    overflow-y: auto;
    min-height: 200px;
}

.kanban-card {
    background: var(--bg-primary);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    cursor: grab;
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
}

.kanban-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.kanban-card.dragging {
    opacity: 0.5;
    cursor: grabbing;
}

.kanban-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.5rem;
}

.kanban-card-ref {
    font-family: monospace;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.kanban-card-title {
    font-weight: 500;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.kanban-card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.kanban-card-meta span {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.kanban-card.overdue {
    border-left: 3px solid #dc3545;
}

.kanban-card.overdue::before {
    content: 'OVERDUE';
    display: block;
    background: #dc3545;
    color: white;
    font-size: 0.65rem;
    font-weight: 600;
    padding: 0.15rem 0.5rem;
    margin: -1rem -1rem 0.75rem -1rem;
    border-radius: 7px 7px 0 0;
}

.priority-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
}

.priority-low { background-color: #6c757d; }
.priority-normal { background-color: #17a2b8; }
.priority-high { background-color: #ffc107; }
.priority-urgent { background-color: #dc3545; }

.sortable-ghost {
    opacity: 0.4;
}

.sortable-chosen {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Kanban Board</h1>
        <p class="text-muted">Drag and drop cards to update request status</p>
    </div>
    <div class="d-flex gap-2">
        <select class="form-select form-select-sm" id="filterTeam" onchange="loadKanban()">
            <option value="">All Teams</option>
        </select>
        <select class="form-select form-select-sm" id="filterPriority" onchange="loadKanban()">
            <option value="">All Priorities</option>
            <option value="urgent">Urgent</option>
            <option value="high">High</option>
            <option value="normal">Normal</option>
            <option value="low">Low</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="showCreateRequestModal()">
            <i class="bi bi-plus-lg"></i> New
        </button>
    </div>
</div>

<div class="kanban-board" id="kanbanBoard">
    <div class="text-center w-100 py-5">
        <div class="spinner-border" role="status"></div>
        <p class="mt-2">Loading board...</p>
    </div>
</div>

<!-- Request Detail Modal -->
<div class="modal fade" id="requestDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalTitle">Request Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="requestDetailBody">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editRequest()">Edit</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Request Modal -->
<div class="modal fade" id="createRequestModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Maintenance Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createRequestForm" onsubmit="createRequest(event)">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Title *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Equipment</label>
                            <select class="form-select" name="equipment_id" id="equipmentSelect">
                                <option value="">Select Equipment</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Team</label>
                            <select class="form-select" name="team_id" id="teamSelect">
                                <option value="">Select Team</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="request_type">
                                <option value="corrective">Corrective</option>
                                <option value="preventive">Preventive</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Priority</label>
                            <select class="form-select" name="priority">
                                <option value="low">Low</option>
                                <option value="normal" selected>Normal</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Scheduled Date</label>
                            <input type="datetime-local" class="form-control" name="scheduled_date">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Deadline</label>
                            <input type="datetime-local" class="form-control" name="deadline">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Request</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
let stages = [];
let requests = [];
let currentRequestId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadFilters();
    loadKanban();
});

async function loadFilters() {
    // Load teams for filter
    const teamResponse = await fetch('/api/teams');
    const teams = await teamResponse.json();
    const teamFilter = document.getElementById('filterTeam');
    teams.forEach(team => {
        teamFilter.innerHTML += `<option value="${team.id}">${team.name}</option>`;
    });
    
    // For create modal
    const teamSelect = document.getElementById('teamSelect');
    teams.forEach(team => {
        teamSelect.innerHTML += `<option value="${team.id}">${team.name}</option>`;
    });
    
    // Load equipment for create modal
    const eqResponse = await fetch('/api/equipment');
    const equipment = await eqResponse.json();
    const eqSelect = document.getElementById('equipmentSelect');
    equipment.forEach(eq => {
        eqSelect.innerHTML += `<option value="${eq.id}">${eq.code} - ${eq.name}</option>`;
    });
}

async function loadKanban() {
    const board = document.getElementById('kanbanBoard');
    
    // Get filters
    const teamId = document.getElementById('filterTeam').value;
    const priority = document.getElementById('filterPriority').value;
    
    // Load stages
    const stageResponse = await fetch('/api/stages');
    stages = await stageResponse.json();
    
    // Load requests with filters
    let url = '/api/requests?';
    if (teamId) url += `team_id=${teamId}&`;
    if (priority) url += `priority=${priority}&`;
    
    const requestResponse = await fetch(url);
    requests = await requestResponse.json();
    
    // Build kanban board
    board.innerHTML = stages.filter(s => !s.fold || s.request_count > 0).map(stage => `
        <div class="kanban-column" data-stage-id="${stage.id}">
            <div class="kanban-header">
                <h6>
                    <span class="priority-indicator" style="background-color: ${stage.color}"></span>
                    ${stage.name}
                </h6>
                <span class="badge bg-secondary">${requests.filter(r => r.stage_id === stage.id).length}</span>
            </div>
            <div class="kanban-body" id="stage-${stage.id}">
                ${requests.filter(r => r.stage_id === stage.id).map(renderCard).join('')}
            </div>
        </div>
    `).join('');
    
    // Initialize drag & drop
    initSortable();
}

function renderCard(req) {
    return `
        <div class="kanban-card ${req.is_overdue ? 'overdue' : ''}" 
             data-id="${req.id}" 
             onclick="showRequestDetail(${req.id})">
            <div class="kanban-card-header">
                <span class="kanban-card-ref">${req.reference}</span>
                <span class="priority-indicator priority-${req.priority}" title="${req.priority}"></span>
            </div>
            <div class="kanban-card-title">${req.name}</div>
            <div class="kanban-card-meta">
                ${req.equipment_code ? `<span><i class="bi bi-box"></i> ${req.equipment_code}</span>` : ''}
                ${req.team_name ? `<span><i class="bi bi-people"></i> ${req.team_name}</span>` : ''}
                <span><i class="bi bi-${req.request_type === 'corrective' ? 'wrench' : 'calendar-check'}"></i> ${req.request_type}</span>
            </div>
        </div>
    `;
}

function initSortable() {
    stages.forEach(stage => {
        const el = document.getElementById(`stage-${stage.id}`);
        if (el) {
            new Sortable(el, {
                group: 'kanban',
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onEnd: async function(evt) {
                    const requestId = evt.item.dataset.id;
                    const newStageId = evt.to.id.replace('stage-', '');
                    
                    if (evt.from !== evt.to) {
                        await moveRequest(requestId, newStageId);
                    }
                }
            });
        }
    });
}

async function moveRequest(requestId, stageId) {
    try {
        const response = await fetch(`/api/requests/${requestId}/move-stage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stage_id: parseInt(stageId) })
        });
        
        if (response.ok) {
            const stage = stages.find(s => s.id === parseInt(stageId));
            showToast(`Moved to ${stage.name}`, 'success');
            // Update badge counts
            loadKanban();
        } else {
            throw new Error('Failed to move');
        }
    } catch (error) {
        showToast('Failed to move request', 'danger');
        loadKanban();
    }
}

async function showRequestDetail(id) {
    currentRequestId = id;
    const modal = new bootstrap.Modal(document.getElementById('requestDetailModal'));
    
    try {
        const response = await fetch(`/api/requests/${id}`);
        const req = await response.json();
        
        document.getElementById('detailModalTitle').textContent = req.reference;
        document.getElementById('requestDetailBody').innerHTML = `
            <div class="row">
                <div class="col-md-8">
                    <h5>${req.name}</h5>
                    <p class="text-muted">${req.description || 'No description'}</p>
                    
                    <h6 class="mt-4">Details</h6>
                    <table class="table table-sm">
                        <tr><td class="text-muted">Equipment</td><td>${req.equipment_name || '-'} ${req.equipment_code ? `(${req.equipment_code})` : ''}</td></tr>
                        <tr><td class="text-muted">Team</td><td>${req.team_name || '-'}</td></tr>
                        <tr><td class="text-muted">Type</td><td>${req.request_type}</td></tr>
                        <tr><td class="text-muted">Requester</td><td>${req.requester_name || '-'}</td></tr>
                        <tr><td class="text-muted">Scheduled</td><td>${req.scheduled_date ? new Date(req.scheduled_date).toLocaleString() : '-'}</td></tr>
                        <tr><td class="text-muted">Deadline</td><td>${req.deadline ? new Date(req.deadline).toLocaleString() : '-'}</td></tr>
                    </table>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="mb-2"><strong>Status</strong></p>
                            <span class="badge" style="background-color: ${req.stage_color}">${req.stage_name}</span>
                            
                            <p class="mb-2 mt-3"><strong>Priority</strong></p>
                            <span class="badge bg-${req.priority_color}">${req.priority}</span>
                            
                            ${req.is_overdue ? '<p class="mt-3"><span class="badge bg-danger">OVERDUE</span></p>' : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        modal.show();
    } catch (error) {
        showToast('Failed to load request', 'danger');
    }
}

function showCreateRequestModal() {
    new bootstrap.Modal(document.getElementById('createRequestModal')).show();
}

async function createRequest(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    Object.keys(data).forEach(key => {
        if (data[key] === '') data[key] = null;
    });
    
    try {
        const response = await fetch('/api/requests', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('createRequestModal')).hide();
            form.reset();
            showToast('Request created!', 'success');
            loadKanban();
        }
    } catch (error) {
        showToast('Failed to create request', 'danger');
    }
}
</script>
{% endblock %}
