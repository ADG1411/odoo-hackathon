{% extends "base.html" %}

{% block title %}Categories - GearGuard{% endblock %}

{% block extra_css %}
<style>
  /* Cards Grid */
  .management-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: var(--space-lg);
  }
  
  /* Management Card */
  .management-card {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-card);
    padding: var(--space-xl);
    transition: all var(--transition-normal);
    border: 1px solid transparent;
    position: relative;
    overflow: hidden;
  }
  
  .management-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-card-hover);
    border-color: var(--border-light);
  }
  
  .management-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #f59e0b, #d97706);
    opacity: 0;
    transition: opacity var(--transition-fast);
  }
  
  .management-card:hover::before {
    opacity: 1;
  }
  
  /* Card Header */
  .card-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-lg);
  }
  
  .card-icon-wrapper {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #d97706;
  }
  
  .card-actions {
    display: flex;
    gap: var(--space-xs);
  }
  
  .card-action-btn {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-md);
    border: none;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
  }
  
  .card-action-btn:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
  }
  
  .card-action-btn.danger:hover {
    background: var(--danger-light);
    color: var(--danger);
  }
  
  /* Card Body */
  .card-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
  }
  
  .card-company {
    font-size: 0.875rem;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    margin-bottom: var(--space-lg);
  }
  
  /* Responsible Info */
  .responsible-info {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-light);
  }
  
  .responsible-avatar {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
    color: #4f46e5;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: 600;
  }
  
  .responsible-details {
    flex: 1;
  }
  
  .responsible-name {
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--text-primary);
  }
  
  .responsible-label {
    font-size: 0.75rem;
    color: var(--text-muted);
  }
  
  /* Empty State */
  .empty-state {
    text-align: center;
    padding: var(--space-2xl) var(--space-xl);
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-card);
  }
  
  .empty-state-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto var(--space-lg);
    background: var(--bg-hover);
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
  }
  
  .empty-state-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
  }
  
  .empty-state-desc {
    font-size: 0.9375rem;
    color: var(--text-muted);
    margin-bottom: var(--space-xl);
    max-width: 360px;
    margin-left: auto;
    margin-right: auto;
  }
  
  /* Modal Panel */
  .modal-panel {
    position: fixed;
    top: 0;
    right: -480px;
    width: 480px;
    height: 100vh;
    background: var(--bg-card);
    box-shadow: var(--shadow-xl);
    z-index: 1001;
    display: flex;
    flex-direction: column;
    transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .modal-panel.active {
    right: 0;
  }
  
  .modal-panel-header {
    padding: var(--space-xl);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .modal-panel-title {
    font-size: 1.25rem;
    font-weight: 600;
  }
  
  .modal-panel-body {
    flex: 1;
    padding: var(--space-xl);
    overflow-y: auto;
  }
  
  .modal-panel-footer {
    padding: var(--space-lg) var(--space-xl);
    border-top: 1px solid var(--border-light);
    display: flex;
    gap: var(--space-md);
    justify-content: flex-end;
    background: var(--bg-hover);
  }
  
  /* Form Styles */
  .form-section {
    margin-bottom: var(--space-xl);
  }
  
  .form-section-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: var(--space-md);
  }
  
  .form-group {
    margin-bottom: var(--space-lg);
  }
  
  .form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
  }
  
  .form-label .required {
    color: var(--danger);
    margin-left: 2px;
  }
  
  /* Stats Header */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-xl);
  }
  
  .section-stats {
    display: flex;
    gap: var(--space-lg);
  }
  
  .stat-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-card);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
  }
  
  .stat-icon {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--warning-light);
    color: var(--warning);
  }
  
  .stat-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-primary);
  }
  
  .stat-label {
    font-size: 0.75rem;
    color: var(--text-muted);
  }
  
  /* Responsive */
  @media (max-width: 1024px) {
    .management-grid {
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
  }
  
  @media (max-width: 768px) {
    .management-grid {
      grid-template-columns: 1fr;
    }
    
    .modal-panel {
      width: 100%;
      right: -100%;
    }
    
    .section-header {
      flex-direction: column;
      gap: var(--space-md);
      align-items: flex-start;
    }
  }
</style>
{% endblock %}

{% block body %}
<div class="app-layout">
  {% include "partials/sidebar.html" %}
  
  <main class="main-content">
    <header class="page-header">
      <div class="page-header-content">
        <div class="page-title-section">
          <nav class="page-breadcrumb">
            <a href="/">Home</a>
            <i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i>
            <span>Categories</span>
          </nav>
          <h1 class="page-title">Categories Management</h1>
        </div>
        
        <div class="page-actions">
          <button class="btn btn-primary" onclick="openAddModal()">
            <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
            <span>Add Category</span>
          </button>
        </div>
      </div>
    </header>
    
    <div class="page-body">
      <div class="page-body-inner">
        <!-- Section Header -->
        <div class="section-header">
          <div class="section-stats">
            <div class="stat-item">
              <div class="stat-icon">
                <i data-lucide="folder-tree" style="width: 16px; height: 16px;"></i>
              </div>
              <div>
                <div class="stat-value" id="total-categories">6</div>
                <div class="stat-label">Total Categories</div>
              </div>
            </div>
          </div>
          
          <div class="search-wrapper" style="position: relative;">
            <i data-lucide="search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-muted);"></i>
            <input type="text" class="form-input" placeholder="Search categories..." style="padding-left: 40px; width: 240px;" oninput="filterCategories(this.value)">
          </div>
        </div>
        
        <!-- Categories Grid -->
        <div class="management-grid" id="categories-grid"></div>
        
        <!-- Empty State -->
        <div class="empty-state" id="categories-empty" style="display: none;">
          <div class="empty-state-icon">
            <i data-lucide="folder-tree" style="width: 40px; height: 40px;"></i>
          </div>
          <h3 class="empty-state-title">No categories added yet</h3>
          <p class="empty-state-desc">Create categories to organize and classify your equipment and maintenance tasks.</p>
          <button class="btn btn-primary" onclick="openAddModal()">
            <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
            Create your first category
          </button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Overlay -->
<div class="side-panel-overlay" id="modal-overlay" onclick="closeModal()"></div>

<!-- Category Modal Panel -->
<div class="modal-panel" id="category-modal">
  <div class="modal-panel-header">
    <h2 class="modal-panel-title" id="category-modal-title">Add Category</h2>
    <button class="btn btn-ghost btn-icon-sm" onclick="closeModal()">
      <i data-lucide="x" style="width: 20px; height: 20px;"></i>
    </button>
  </div>
  
  <div class="modal-panel-body">
    <form id="category-form">
      <input type="hidden" id="category-id">
      
      <div class="form-section">
        <div class="form-section-title">Category Information</div>
        
        <div class="form-group">
          <label class="form-label">Category Name <span class="required">*</span></label>
          <input type="text" class="form-input" id="category-name" placeholder="e.g., Industrial Machinery" required>
          <span class="form-error" id="category-name-error"></span>
        </div>
        
        <div class="form-group">
          <label class="form-label">Company Name <span class="required">*</span></label>
          <input type="text" class="form-input" id="category-company" placeholder="e.g., Acme Industries" required>
          <span class="form-error" id="category-company-error"></span>
        </div>
      </div>
      
      <div class="form-section">
        <div class="form-section-title">Responsibility</div>
        
        <div class="form-group">
          <label class="form-label">Responsible Person <span class="required">*</span></label>
          <select class="form-select" id="category-responsible" required>
            <option value="">Select responsible person</option>
          </select>
          <span class="form-error" id="category-responsible-error"></span>
        </div>
      </div>
    </form>
  </div>
  
  <div class="modal-panel-footer">
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" onclick="saveCategory(event)">
      <i data-lucide="check" style="width: 16px; height: 16px;"></i>
      <span id="category-save-btn-text">Save Category</span>
    </button>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="delete-modal" style="display: none;">
  <div class="modal-backdrop" onclick="closeDeleteModal()"></div>
  <div class="modal-content" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title">Confirm Delete</h2>
      <button class="modal-close" onclick="closeDeleteModal()">
        <i data-lucide="x" style="width: 20px; height: 20px;"></i>
      </button>
    </div>
    <div class="modal-body" style="text-align: center; padding: var(--space-xl);">
      <div style="width: 64px; height: 64px; margin: 0 auto var(--space-lg); background: var(--danger-light); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center;">
        <i data-lucide="trash-2" style="width: 28px; height: 28px; color: var(--danger);"></i>
      </div>
      <h3 style="margin-bottom: var(--space-sm);">Delete <span id="delete-item-name"></span>?</h3>
      <p style="color: var(--text-muted);">This action cannot be undone.</p>
    </div>
    <div class="modal-footer" style="justify-content: center;">
      <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
      <button class="btn btn-danger" onclick="confirmDelete()">
        <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
        Delete
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let editingId = null;
let deleteId = null;

let categories = [
  { id: 1, name: 'Industrial Machinery', responsible: 'Mike Wilson', responsibleInitials: 'MW', company: 'Acme Industries' },
  { id: 2, name: 'HVAC Systems', responsible: 'Sarah Connor', responsibleInitials: 'SC', company: 'Acme Industries' },
  { id: 3, name: 'Electrical Equipment', responsible: 'John Davis', responsibleInitials: 'JD', company: 'Acme Industries' },
  { id: 4, name: 'Hydraulic Systems', responsible: 'James Brown', responsibleInitials: 'JB', company: 'TechCorp Ltd' },
  { id: 5, name: 'Conveyor Systems', responsible: 'Rachel Kim', responsibleInitials: 'RK', company: 'TechCorp Ltd' },
  { id: 6, name: 'Safety Equipment', responsible: 'Tom Lee', responsibleInitials: 'TL', company: 'Industrial Co' }
];

const allMembers = [
  { id: 1, name: 'Mike Wilson', role: 'Senior Technician', initials: 'MW' },
  { id: 2, name: 'John Davis', role: 'Technician', initials: 'JD' },
  { id: 3, name: 'Sarah Connor', role: 'Lead Engineer', initials: 'SC' },
  { id: 4, name: 'James Brown', role: 'Maintenance Specialist', initials: 'JB' },
  { id: 5, name: 'Rachel Kim', role: 'Technician', initials: 'RK' },
  { id: 6, name: 'Tom Lee', role: 'Engineer', initials: 'TL' },
  { id: 7, name: 'Mary Harris', role: 'Supervisor', initials: 'MH' },
  { id: 8, name: 'Alex Walker', role: 'Technician', initials: 'AW' },
  { id: 9, name: 'Kate Park', role: 'Engineer', initials: 'KP' },
  { id: 10, name: 'David Miller', role: 'Specialist', initials: 'DM' }
];

document.addEventListener('DOMContentLoaded', function() {
  renderCategories();
  populateResponsibleSelect();
  updateStats();
});

function renderCategories(filter = '') {
  const grid = document.getElementById('categories-grid');
  const empty = document.getElementById('categories-empty');
  
  const filteredCategories = categories.filter(c => 
    c.name.toLowerCase().includes(filter.toLowerCase()) ||
    c.company.toLowerCase().includes(filter.toLowerCase()) ||
    c.responsible.toLowerCase().includes(filter.toLowerCase())
  );
  
  if (filteredCategories.length === 0) {
    grid.style.display = 'none';
    empty.style.display = 'block';
    return;
  }
  
  grid.style.display = 'grid';
  empty.style.display = 'none';
  
  grid.innerHTML = filteredCategories.map(cat => `
    <div class="management-card">
      <div class="card-top">
        <div class="card-icon-wrapper">
          <i data-lucide="folder" style="width: 24px; height: 24px;"></i>
        </div>
        <div class="card-actions">
          <button class="card-action-btn" onclick="editCategory(${cat.id})" title="Edit">
            <i data-lucide="pencil" style="width: 16px; height: 16px;"></i>
          </button>
          <button class="card-action-btn danger" onclick="deleteItem(${cat.id}, '${cat.name}')" title="Delete">
            <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
          </button>
        </div>
      </div>
      
      <h3 class="card-title">${cat.name}</h3>
      <div class="card-company">
        <i data-lucide="building-2" style="width: 14px; height: 14px;"></i>
        ${cat.company}
      </div>
      
      <div class="responsible-info">
        <div class="responsible-avatar">${cat.responsibleInitials}</div>
        <div class="responsible-details">
          <div class="responsible-name">${cat.responsible}</div>
          <div class="responsible-label">Responsible Person</div>
        </div>
      </div>
    </div>
  `).join('');
  
  lucide.createIcons();
}

function filterCategories(value) {
  renderCategories(value);
}

function updateStats() {
  document.getElementById('total-categories').textContent = categories.length;
}

function openAddModal() {
  editingId = null;
  document.getElementById('category-modal-title').textContent = 'Add Category';
  document.getElementById('category-save-btn-text').textContent = 'Save Category';
  document.getElementById('category-form').reset();
  document.getElementById('category-modal').classList.add('active');
  document.getElementById('modal-overlay').classList.add('active');
}

function closeModal() {
  document.getElementById('category-modal').classList.remove('active');
  document.getElementById('modal-overlay').classList.remove('active');
}

function editCategory(id) {
  const category = categories.find(c => c.id === id);
  if (!category) return;
  
  editingId = id;
  document.getElementById('category-modal-title').textContent = 'Edit Category';
  document.getElementById('category-save-btn-text').textContent = 'Update Category';
  document.getElementById('category-id').value = id;
  document.getElementById('category-name').value = category.name;
  document.getElementById('category-company').value = category.company;
  
  const responsible = allMembers.find(m => m.name === category.responsible);
  if (responsible) {
    document.getElementById('category-responsible').value = responsible.id;
  }
  
  document.getElementById('category-modal').classList.add('active');
  document.getElementById('modal-overlay').classList.add('active');
}

function saveCategory(e) {
  e.preventDefault();
  
  const name = document.getElementById('category-name').value.trim();
  const company = document.getElementById('category-company').value.trim();
  const responsibleId = document.getElementById('category-responsible').value;
  
  let hasError = false;
  
  if (!name) {
    document.getElementById('category-name-error').textContent = 'Category name is required';
    hasError = true;
  } else {
    document.getElementById('category-name-error').textContent = '';
  }
  
  if (!company) {
    document.getElementById('category-company-error').textContent = 'Company name is required';
    hasError = true;
  } else {
    document.getElementById('category-company-error').textContent = '';
  }
  
  if (!responsibleId) {
    document.getElementById('category-responsible-error').textContent = 'Select a responsible person';
    hasError = true;
  } else {
    document.getElementById('category-responsible-error').textContent = '';
  }
  
  if (hasError) return;
  
  const responsible = allMembers.find(m => m.id === parseInt(responsibleId));
  
  if (editingId) {
    const index = categories.findIndex(c => c.id === editingId);
    if (index !== -1) {
      categories[index] = { 
        ...categories[index], 
        name, 
        company, 
        responsible: responsible.name,
        responsibleInitials: responsible.initials
      };
    }
    showToast('Success', 'Category updated successfully', 'success');
  } else {
    const newId = Math.max(...categories.map(c => c.id), 0) + 1;
    categories.push({ 
      id: newId, 
      name, 
      company, 
      responsible: responsible.name,
      responsibleInitials: responsible.initials
    });
    showToast('Success', 'Category created successfully', 'success');
  }
  
  renderCategories();
  updateStats();
  closeModal();
}

function deleteItem(id, name) {
  deleteId = id;
  document.getElementById('delete-item-name').textContent = name;
  document.getElementById('delete-modal').style.display = 'flex';
  lucide.createIcons();
}

function closeDeleteModal() {
  document.getElementById('delete-modal').style.display = 'none';
  deleteId = null;
}

function confirmDelete() {
  categories = categories.filter(c => c.id !== deleteId);
  renderCategories();
  updateStats();
  showToast('Success', 'Category deleted successfully', 'success');
  closeDeleteModal();
}

function populateResponsibleSelect() {
  const select = document.getElementById('category-responsible');
  select.innerHTML = '<option value="">Select responsible person</option>' +
    allMembers.map(m => `<option value="${m.id}">${m.name} - ${m.role}</option>`).join('');
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeModal();
    closeDeleteModal();
  }
});
</script>
{% endblock %}
